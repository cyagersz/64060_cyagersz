---
title: "Assignment_2"
author: "Cole Yagersz"
output: html_document
---


```{r}
library("class")
library("caret")
library("FNN")

bank <- read.csv("UniversalBank.csv")   #Load the data set

bank <- bank[, !(names(bank) %in% c("ID","ZIP.Code"))]   # Remove the variables ID and ZIP

head(bank)

bank$Education <- as.factor(bank$Education)
levels(bank$Education)

dummy_model <- dummyVars(~Education,data=bank)
education_dummy <- predict(dummy_model,newdata = bank)

# Bind dummy vars and remove original Education
bank <- cbind(bank, as.data.frame(education_dummy))
bank$Education <- NULL
head(bank)


numeric_vars <- c("Age", "Experience", "Income", "CCAvg", "Mortgage","Family")
norm_model <- preProcess(bank[, numeric_vars], method = c("range"))
bank[, numeric_vars] <- predict(norm_model, bank[, numeric_vars])
summary(bank[, numeric_vars])


# Partition the data into 60% training and 40% validation
set.seed(123)

#stratified based on personal loan acceptance 
train_index <- createDataPartition(bank$Personal.Loan, p = 0.6, list = FALSE)   
train_data <- bank[train_index, ]
valid_data <- bank[-train_index, ]

summary(train_index)
summary(train_data)
summary(valid_data)


# Separate predictors and labels for train and validation
train_X <- train_data[, !(names(train_data) %in% c("Personal.Loan"))]
train_Y <- train_data$Personal.Loan

valid_X <- valid_data[, !(names(valid_data) %in% c("Personal.Loan"))]
valid_Y <- valid_data$Personal.Loan


# Create new customer 
new_customer <- data.frame(
  Age = 40,
  Experience = 10,
  Income = 84,
  Family = 2,
  CCAvg = 2,
  Mortgage = 0,
  Securities.Account = 0,
  CD.Account = 0,
  Online = 1,
  Credit.Card = 1,
  Education1 = 0,
  Education2 = 1,
  Education3 = 0
)

new_customer[, c("Age", "Experience", "Income", "CCAvg", "Mortgage","Family")] <- 
  predict(norm_model, new_customer[, c("Age", "Experience", "Income", "CCAvg", "Mortgage","Family")])


# Run k-nn with k=1
prediction <- knn(train = train_X, test = new_customer, cl = train_Y, k = 1)

# Question 1 answer is the customer will not accept the loan 
print(paste("The customer classification is", prediction))
```

Hypertuning using validation
```{r}
library("caret")
library("FNN")
library("class")


accuracy.df <- data.frame(k = seq(1, 20, 1), Accuracy = rep(0, 20))

train_Y <- factor(train_Y)
valid_Y <- factor(valid_Y)

# compute knn for different k on validation.
for(i in 1:20) {
  knn.pred <- knn(train_X, valid_X, 
                  cl = train_Y, k = i)
  accuracy.df[i, 2] <- confusionMatrix(knn.pred, valid_Y)$overall["Accuracy"] 
}
accuracy.df
```
Based on the validation accuracy k=1 has the highest accuracy of 96.2% showing that the model fits but could lead to overfitting. As k increases the accuracy drops a bit but remains high. Choosing a k=3  could provide a better balance between overfitting and ignoring useful information.k=3 is a good choice to balance bias and variance for this classification.

Confusion Matrix
```{r}
library("gmodels")

best_k <- 3

knn.best <- knn(train = train_X, test = valid_X, cl = train_Y, k = best_k)
CrossTable(x = valid_Y, y = knn.best, prop.chisq = FALSE)

```

Classify customer with best k
```{r}


prediction2 <- knn(train = train_X, test = new_customer, cl = train_Y, k = best_k)

print(paste("The customer classification is", prediction2))
```


Repartition the data 50%:30%:20%
```{r}

library("class")
library("FNN")
library("gmodels")


set.seed(123)

test_index <- createDataPartition(bank$Personal.Loan, p = 0.2, list = FALSE) # 20%  
test_data <- bank[test_index, ]
bank_data <- bank[-test_index, ]


train_index <- createDataPartition(bank_data$Personal.Loan, p = .625, list = FALSE) # 50%
train_data <- bank_data[train_index, ]
valid_data <- bank_data[-train_index, ] # 30% 

summary(test_data)
summary(train_data)
summary(valid_data)



# Training
train_X <- train_data[, !(names(train_data) %in% c("Personal.Loan"))]
train_Y <- factor(train_data$Personal.Loan)

# Validation
valid_X <- valid_data[, !(names(valid_data) %in% c("Personal.Loan"))]
valid_Y <- factor(valid_data$Personal.Loan)

# Test
test_X <- test_data[, !(names(test_data) %in% c("Personal.Loan"))]
test_Y <- factor(test_data$Personal.Loan)



best_k <- 3

# Predictions
train_pred <- knn(train = train_X, test = train_X, cl = train_Y, k = best_k)
valid_pred <- knn(train = train_X, test = valid_X, cl = train_Y, k = best_k)
test_pred <- knn(train = train_X, test = test_X, cl = train_Y, k = best_k)


# Training
CrossTable(x = train_Y, y = train_pred, prop.chisq = FALSE)

# Validation
CrossTable(x = valid_Y, y = valid_pred, prop.chisq = FALSE)

# Test
CrossTable(x = test_Y, y = test_pred, prop.chisq = FALSE)
```